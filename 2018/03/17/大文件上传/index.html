<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Tongby"><title>大文件上传 · Nostalgia</title><meta name="description" content="大文件断点续传(上传篇)###吐槽阶段（可以跳过）
由于之前按照公司的需求要做一个 （简单!!!） 云盘类的功能，既然是云盘基础的就是上传下载，于是基于AFN做了一个展示加进度、不可暂停、不可续传的简单传输列表，不知道老大哪天奇思妙想要求加了一个可以断点续传可以断点下载的功能，作为一个有原则的程序猿"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Nostalgia</a></h3></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>大文件上传</a></h3></div><div class="post-content"><h1 id="大文件断点续传-上传篇"><a href="#大文件断点续传-上传篇" class="headerlink" title="大文件断点续传(上传篇)"></a>大文件断点续传(上传篇)</h1><p>###吐槽阶段（可以跳过）</p>
<p>由于之前按照公司的需求要做一个 （简单!!!） 云盘类的功能，既然是云盘基础的就是上传下载，于是基于AFN做了一个展示加进度、不可暂停、不可续传的简单传输列表，不知道老大哪天奇思妙想要求加了一个可以断点续传可以断点下载的功能，作为一个有原则的程序猿，只能点头答应嗯能做,于是开始google…</p>
<p>###google结果<br>不清楚是我搜的方式不对还是说当时没有人做这个功能我是没有搜到可以复制粘贴的代码（妄想做一个代码的搬运工）最后庆幸的是断点续传没找到，不过找到了一份还不错的断点下载的demo，扯远了本篇只说断点上传。</p>
<p>###正文开始<br>前提由于我先做的下载是基于原生的<code>NSURLSessionDownloadTask</code>封装的下载管理类，所有首先想到的是同样基于<code>NSURLSessionUploadTask</code>做一个一样的断点续传管理类，中间第一步就是公司的后台的<code>HTTPS</code>中的<code>header</code>中<code>cookie</code>一定要带着id还有就是在上传文件体的时候需要转换的文件格式，这是本人在网上借鉴到的代码看的第一眼就有点晕晕感觉（本人才疏学浅）</p>
<p><img src="media/15206505594861/2F1C465A-C6BF-483C-9B08-2E196E2391C4.png" alt="2F1C465A-C6BF-483C-9B08-2E196E2391"></p>
<p>但是还坚持这接着写，文件体的问题解决了，又遇到<code>https</code>证书的问题由于开发阶段没有域名都是ip地址直接访问，导致不安全无法访问，改info.plist忽略认证并不起作用，最后是通过这个代理解决的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//主要就是处理HTTPS请求的</span><br><span class="line">- (void)URLSession:(NSURLSession *)session didReceiveChallenge:(NSURLAuthenticationChallenge *)challenge completionHandler:(void (^)(NSURLSessionAuthChallengeDisposition, NSURLCredential *))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    NSURLProtectionSpace *protectionSpace = challenge.protectionSpace;</span><br><span class="line">    if ([protectionSpace.authenticationMethod isEqualToString:NSURLAuthenticationMethodServerTrust]) &#123;</span><br><span class="line">        SecTrustRef serverTrust = protectionSpace.serverTrust;</span><br><span class="line">        completionHandler(NSURLSessionAuthChallengeUseCredential, [NSURLCredential credentialForTrust:serverTrust]);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        completionHandler(NSURLSessionAuthChallengePerformDefaultHandling, nil);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当写到这里的时候都是在尝试阶段发现并不是我想要的样子复杂程度不提就是以后遇到的坑还不清楚有多少维护成本太高了，于是开始研究<code>AFN</code>。</p>
<p>###开始AFN断点上传<br><code>AFN</code>就不介绍了，直接动手上传文件首先把想要上传的文件整理成对应的上传文件的模型。</p>
<ol>
<li>上传文件转模型的代码需要带着唯一标示</li>
<li>然后去数据库中查询对应的文件如果有直接取出，没有直接进行下一步</li>
<li>去服务器要当前文件的已经上传的进度，我们的项目是通过文件的MD5</li>
<li>然后在创建队列的中进行分片然后循环上传，成功的话进行下一片，失败直接退出循环。进行下一个文件的上传</li>
<li>由于需求所以目前是一个文件一个文件的同步队列上传等待的机制，同一个文件的等待机制我是靠队列管理的，不同文件的上传是靠数组手动管理的</li>
<li>至于进度的回调及完成失败的状态回调是通过通知来发送的</li>
<li>重点地单个任务的删除要删除整个任务和文件首先要删除这个任务就要找到对应的task，由于基于AFN所有上次的任务会返回给你，然后之前是用模型存起来的 但是由于没次打开界面是通过数据库查出来的（由于小子对于数据库不是很精通所欲没有想到如何把这个任务存起来），后来由于当前的上传管理类的单例模式建的类在APP重新启动前是不会释放掉的于是把当前任务保存在了本地的内存中用一个字典来管理value是task key是对应的上传文件的唯一标示</li>
</ol>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-03-17</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2018/03/17/大文件上传/,Nostalgia,大文件上传,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/03/17/测试/" title="测试">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>